<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Terminal - Direct SSH Connection</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #2d2d2d;
            padding: 10px 20px;
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4444;
            transition: background 0.3s;
        }
        
        .status-dot.connected {
            background: #00ff00;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 15px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00ff00;
            color: #000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .terminal-container {
            flex: 1;
            padding: 10px;
        }
        
        #terminal {
            height: 100%;
            background: #000;
            border: 1px solid #333;
        }
        
        .info-panel {
            background: #2d2d2d;
            padding: 15px;
            border-top: 1px solid #333;
            font-size: 12px;
        }
        
        .commands {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .command-group {
            background: #333;
            padding: 8px;
            border-radius: 4px;
        }
        
        .command-title {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .error-message {
            background: #4a1a1a;
            color: #ff6666;
            padding: 10px;
            margin: 10px;
            border: 1px solid #ff4444;
            border-radius: 4px;
            display: none;
        }
        
        .config-panel {
            background: #2d2d2d;
            padding: 15px;
            border-bottom: 1px solid #333;
            display: none;
        }
        
        .config-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        
        input {
            background: #000;
            color: #00ff00;
            border: 1px solid #333;
            padding: 5px;
            font-family: inherit;
            flex: 1;
        }
        
        label {
            min-width: 100px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
        <div class="controls">
            <button id="configBtn" onclick="toggleConfig()">Config</button>
            <button id="connectBtn" onclick="connect()">Connect</button>
            <button id="clearBtn" onclick="clearTerminal()">Clear</button>
        </div>
    </div>
    
    <div class="error-message" id="errorMessage"></div>
    
    <div class="config-panel" id="configPanel">
        <div class="config-row">
            <label>EC2 Host:</label>
            <input type="text" id="sshHost" value="ec2-13-60-242-174.eu-north-1.compute.amazonaws.com" />
        </div>
        <div class="config-row">
            <label>Username:</label>
            <input type="text" id="sshUser" value="ubuntu" />
        </div>
        <div class="config-row">
            <label>Port:</label>
            <input type="number" id="sshPort" value="22" />
        </div>
        <div class="config-row">
            <label>Server URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:7777" />
        </div>
        <div class="config-row">
            <label>SSH Private Key:</label>
            <textarea id="sshPrivateKey" placeholder="Optional - Server will auto-find SSH keys if left empty" rows="3" style="font-family: monospace; font-size: 10px; width: 100%;"></textarea>
        </div>
    </div>
    
    <div class="terminal-container">
        <div id="terminal"></div>
    </div>
    
    <div class="info-panel">
        <div><strong>Claude Terminal Interface</strong> - Direct SSH connection to EC2 Claude agent</div>
        <div class="commands">
            <div class="command-group">
                <div class="command-title">Connection:</div>
                <div>1. Click Config (optional - auto-detects)</div>
                <div>2. Click Connect to establish SSH</div>
                <div>3. Claude Code starts automatically!</div>
            </div>
            <div class="command-group">
                <div class="command-title">Commands:</div>
                <div><code>claude --help</code> - Claude help</div>
                <div><code>ls</code> - List files</div>
                <div><code>pwd</code> - Current directory</div>
            </div>
            <div class="command-group">
                <div class="command-title">Claude:</div>
                <div><code>help</code> - Claude help</div>
                <div><code>/exit</code> - Exit Claude</div>
                <div>Type naturally to chat with Claude</div>
            </div>
        </div>
    </div>

    <script>
        // Terminal setup
        const terminal = new Terminal({
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: 'Courier New, monospace',
            theme: {
                background: '#000000',
                foreground: '#00ff00',
                cursor: '#00ff00',
                selection: '#333333'
            },
            rows: 30,
            cols: 100
        });
        
        const fitAddon = new FitAddon.FitAddon();
        terminal.loadAddon(fitAddon);
        terminal.open(document.getElementById('terminal'));
        fitAddon.fit();
        
        // Socket connection
        let socket = null;
        let isConnected = false;
        let claudeStarted = false;
        let terminalSessionId = null;
        
        // UI elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        // const startClaudeBtn = document.getElementById('startClaudeBtn'); // Removed - auto-starts
        const errorMessage = document.getElementById('errorMessage');
        const configPanel = document.getElementById('configPanel');
        
        // Configuration
        function toggleConfig() {
            configPanel.style.display = configPanel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        function updateStatus(connected, text) {
            isConnected = connected;
            statusDot.className = `status-dot ${connected ? 'connected' : ''}`;
            statusText.textContent = text;
            connectBtn.textContent = connected ? 'Disconnect' : 'Connect';
        }
        
        // Connect to server
        function connect() {
            if (isConnected) {
                disconnect();
                return;
            }
            
            const serverUrl = document.getElementById('serverUrl').value;
            
            terminal.writeln('🔌 Connecting to server...');
            
            socket = io(serverUrl);
            
            socket.on('connect', () => {
                terminal.writeln('✅ Connected to server');
                updateStatus(true, 'Connected to server');
                
                // Request SSH connection
                const config = {
                    host: document.getElementById('sshHost').value,
                    username: document.getElementById('sshUser').value,
                    port: parseInt(document.getElementById('sshPort').value),
                    privateKey: document.getElementById('sshPrivateKey').value.trim()
                };
                
                terminal.writeln(`🔐 Connecting to SSH: ${config.username}@${config.host}:${config.port}`);
                socket.emit('ssh-connect', config);
            });
            
            socket.on('disconnect', () => {
                terminal.writeln('\n❌ Server disconnected');
                updateStatus(false, 'Disconnected');
                claudeStarted = false;
            });
            
            socket.on('ssh-connected', (data) => {
                terminal.writeln(`✅ SSH connected: ${data.sessionId}`);
                terminalSessionId = data.sessionId;
                updateStatus(true, 'SSH Connected');
                terminal.writeln('🤖 Claude Code will start automatically...');
            });
            
            socket.on('ssh-error', (data) => {
                terminal.writeln(`❌ SSH Error: ${data.error}`);
                showError(`SSH connection failed: ${data.error}`);
                updateStatus(false, 'SSH Failed');
            });
            
            socket.on('ssh-output', (data) => {
                if (data.sessionId === terminalSessionId) {
                    terminal.write(data.output);
                }
            });
            
            socket.on('claude-started', (data) => {
                terminal.writeln('\\n🤖 Claude Code is ready! Start coding...');
                claudeStarted = true;
                updateStatus(true, 'Claude Code Active');
            });
            
            socket.on('error', (error) => {
                terminal.writeln(`\\n💥 Error: ${error.message}`);
                showError(error.message);
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            updateStatus(false, 'Disconnected');
            claudeStarted = false;
            terminalSessionId = null;
        }
        
        // startClaude function removed - Claude starts automatically
        
        function clearTerminal() {
            terminal.clear();
        }
        
        // Handle terminal input - direct passthrough to SSH
        terminal.onData((data) => {
            if (!isConnected || !terminalSessionId) {
                terminal.write('\\a'); // Bell sound for not connected
                return;
            }
            
            // Send all input directly to SSH session (including control characters)
            socket.emit('ssh-input', {
                sessionId: terminalSessionId,
                input: data
            });
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            fitAddon.fit();
            if (socket && terminalSessionId) {
                socket.emit('ssh-resize', {
                    sessionId: terminalSessionId,
                    cols: terminal.cols,
                    rows: terminal.rows
                });
            }
        });
        
        // Initial terminal message
        terminal.writeln('🚀 Claude Code Terminal Interface');
        terminal.writeln('═══════════════════════════════════');
        terminal.writeln('1. Click Connect (auto-detects SSH key & EC2 config)');
        terminal.writeln('2. Claude Code starts automatically on connection');
        terminal.writeln('3. Start coding with Claude immediately!');
        terminal.writeln('');
        terminal.writeln('Ready to connect to Claude Code...');
    </script>
</body>
</html>