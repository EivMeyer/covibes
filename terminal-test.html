<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Code Agent Terminal - Working Version</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #000;
      color: #0f0;
      font-family: 'Courier New', monospace;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #header {
      background: #111;
      padding: 15px;
      border-bottom: 2px solid #0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #status {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #666;
    }
    .status-indicator.connected {
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    .status-indicator.error {
      background: #f00;
      box-shadow: 0 0 10px #f00;
    }
    #terminal-container {
      flex: 1;
      padding: 10px;
      overflow: hidden;
    }
    #terminal {
      width: 100%;
      height: 100%;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #0a0;
      box-shadow: 0 0 10px #0f0;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #logs {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid #0f0;
      padding: 10px;
      max-width: 400px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      display: none;
    }
    #logs.visible {
      display: block;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 2px;
    }
    .log-error {
      color: #f00;
    }
    .log-success {
      color: #0f0;
    }
    .log-info {
      color: #ff0;
    }
  </style>
</head>
<body>
  <div id="header">
    <div>
      <h1 style="color: #0f0; text-shadow: 0 0 10px #0f0;">Claude Code Terminal</h1>
    </div>
    <div id="status">
      <div class="status-item">
        <span>Socket:</span>
        <div id="socket-status" class="status-indicator"></div>
        <span id="socket-text">Disconnected</span>
      </div>
      <div class="status-item">
        <span>Agent:</span>
        <div id="agent-status" class="status-indicator"></div>
        <span id="agent-text">Not spawned</span>
      </div>
      <button id="spawn-btn">Spawn Agent</button>
      <button id="log-toggle">Show Logs</button>
    </div>
  </div>

  <div id="terminal-container">
    <div id="terminal"></div>
  </div>

  <div id="logs"></div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    // Configuration
    const BACKEND_URL = 'http://ec2-13-48-135-139.eu-north-1.compute.amazonaws.com:3001';
    const DEMO_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjbTBrbGZlMWQwMDAwMTNwMGc0OWE1MzJnIiwidGVhbUlkIjoiZGVtby10ZWFtLTAwMSIsInVzZXJOYW1lIjoiVGVzdCBVc2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiaWF0IjoxNzI1ODk5OTY0LCJleHAiOjE3NTc0MzU5NjR9.l6Gks7egUqg7Bod59r3gnjLBiAzFCQjtFvNzcrXPNt8';

    // State
    let socket = null;
    let terminal = null;
    let fitAddon = null;
    let currentAgentId = null;
    let isConnected = false;

    // Logging
    const logs = [];
    const maxLogs = 50;

    function addLog(message, type = 'info') {
      const timestamp = new Date().toTimeString().split(' ')[0];
      logs.push({ timestamp, message, type });
      if (logs.length > maxLogs) logs.shift();
      updateLogDisplay();
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateLogDisplay() {
      const logsEl = document.getElementById('logs');
      logsEl.innerHTML = logs.map(log =>
        `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
      ).reverse().join('');
    }

    // UI Updates
    function updateSocketStatus(connected) {
      const indicator = document.getElementById('socket-status');
      const text = document.getElementById('socket-text');
      if (connected) {
        indicator.className = 'status-indicator connected';
        text.textContent = 'Connected';
      } else {
        indicator.className = 'status-indicator error';
        text.textContent = 'Disconnected';
      }
    }

    function updateAgentStatus(status, agentId = null) {
      const indicator = document.getElementById('agent-status');
      const text = document.getElementById('agent-text');
      const btn = document.getElementById('spawn-btn');

      switch(status) {
        case 'spawning':
          indicator.className = 'status-indicator';
          text.textContent = 'Spawning...';
          btn.disabled = true;
          break;
        case 'connected':
          indicator.className = 'status-indicator connected';
          text.textContent = agentId ? agentId.substring(0, 8) : 'Connected';
          btn.disabled = true;
          break;
        case 'error':
          indicator.className = 'status-indicator error';
          text.textContent = 'Error';
          btn.disabled = false;
          break;
        default:
          indicator.className = 'status-indicator';
          text.textContent = 'Not spawned';
          btn.disabled = false;
      }
    }

    // Terminal initialization
    function initTerminal() {
      terminal = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'Consolas, "Liberation Mono", Menlo, monospace',
        theme: {
          background: '#000000',
          foreground: '#00ff00',
          cursor: '#00ff00',
          cursorAccent: '#000000'
        },
        cols: 80,
        rows: 24
      });

      fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);

      terminal.open(document.getElementById('terminal'));
      fitAddon.fit();

      terminal.writeln('\x1b[32m═══════════════════════════════════════════\x1b[0m');
      terminal.writeln('\x1b[32m     Claude Code Agent Terminal v2.0\x1b[0m');
      terminal.writeln('\x1b[32m═══════════════════════════════════════════\x1b[0m');
      terminal.writeln('');
      terminal.writeln('\x1b[33mInitializing...\x1b[0m');

      // Handle terminal input
      terminal.onData((data) => {
        if (currentAgentId && socket) {
          socket.emit('terminal_input', {
            agentId: currentAgentId,
            data: data
          });
        }
      });

      // Handle resize
      window.addEventListener('resize', () => {
        if (fitAddon) {
          fitAddon.fit();
          if (currentAgentId && socket) {
            socket.emit('terminal_resize', {
              agentId: currentAgentId,
              cols: terminal.cols,
              rows: terminal.rows
            });
          }
        }
      });

      addLog('Terminal initialized', 'success');
    }

    // Socket connection
    function connectSocket() {
      addLog('Connecting to server...', 'info');

      socket = io(BACKEND_URL, {
        auth: { token: DEMO_TOKEN },
        transports: ['websocket']
      });

      socket.on('connect', () => {
        isConnected = true;
        updateSocketStatus(true);
        addLog('Socket connected', 'success');
        terminal.writeln('\x1b[32m✓ Connected to server\x1b[0m');
        terminal.writeln('');
      });

      socket.on('disconnect', () => {
        isConnected = false;
        updateSocketStatus(false);
        addLog('Socket disconnected', 'error');
        terminal.writeln('\x1b[31m✗ Disconnected from server\x1b[0m');
      });

      socket.on('error', (error) => {
        addLog(`Socket error: ${error}`, 'error');
        terminal.writeln(`\x1b[31mError: ${error}\x1b[0m`);
      });

      // Terminal events
      socket.on('terminal_connected', (data) => {
        addLog(`Terminal connected: ${JSON.stringify(data)}`, 'success');
        terminal.writeln('\x1b[32m✓ Terminal connected\x1b[0m');
        terminal.writeln('');
        updateAgentStatus('connected', currentAgentId);
      });

      socket.on('terminal_data', (data) => {
        if (data && data.agentId === currentAgentId && data.data) {
          terminal.write(data.data);
        }
      });

      socket.on('terminal_error', (data) => {
        addLog(`Terminal error: ${data.error}`, 'error');
        terminal.writeln(`\x1b[31mTerminal error: ${data.error}\x1b[0m`);
      });

      socket.on('agent_spawned', (data) => {
        addLog(`Agent spawned event received`, 'info');
      });

      socket.on('claude_started', (data) => {
        addLog(`Claude started: ${data.agentId}`, 'success');
      });
    }

    // Spawn agent
    async function spawnAgent() {
      if (!isConnected) {
        addLog('Not connected to server', 'error');
        return;
      }

      updateAgentStatus('spawning');
      terminal.writeln('\x1b[33mSpawning Claude Code agent...\x1b[0m');
      addLog('Spawning agent...', 'info');

      try {
        // Join team first
        socket.emit('join-team', {
          teamId: 'demo-team-001',
          token: DEMO_TOKEN
        });

        // Spawn agent via API
        const response = await fetch(`${BACKEND_URL}/api/agents/spawn`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${DEMO_TOKEN}`
          },
          body: JSON.stringify({
            task: 'Terminal test session',
            teamId: 'demo-team-001'
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        currentAgentId = data.id || data.agentId || data.agent?.id;

        if (!currentAgentId) {
          throw new Error('No agent ID in response');
        }

        addLog(`Agent spawned: ${currentAgentId}`, 'success');
        terminal.writeln(`\x1b[32m✓ Agent spawned: ${currentAgentId}\x1b[0m`);
        terminal.writeln('\x1b[33mConnecting to terminal...\x1b[0m');

        // Connect to terminal
        setTimeout(() => {
          socket.emit('terminal_connect', {
            agentId: currentAgentId
          });
          addLog(`Sent terminal_connect for ${currentAgentId}`, 'info');
        }, 500);

      } catch (error) {
        addLog(`Failed to spawn agent: ${error.message}`, 'error');
        terminal.writeln(`\x1b[31mError: ${error.message}\x1b[0m`);
        updateAgentStatus('error');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTerminal();
      connectSocket();

      // Button handlers
      document.getElementById('spawn-btn').addEventListener('click', spawnAgent);

      document.getElementById('log-toggle').addEventListener('click', () => {
        const logs = document.getElementById('logs');
        const btn = document.getElementById('log-toggle');
        if (logs.classList.contains('visible')) {
          logs.classList.remove('visible');
          btn.textContent = 'Show Logs';
        } else {
          logs.classList.add('visible');
          btn.textContent = 'Hide Logs';
        }
      });
    });
  </script>
</body>
</html>